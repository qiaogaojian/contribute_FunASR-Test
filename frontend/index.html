<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å®æ—¶è¯­éŸ³è½¬æ–‡å­—æ˜¾ç¤º</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;500;700&display=swap" rel="stylesheet">
</head>
<body>
    <div class="container">
        <header class="header">
            <h1>ğŸ¤ å®æ—¶è¯­éŸ³è½¬æ–‡å­—</h1>
            <div class="status-indicator">
                <span class="status-dot" id="statusDot"></span>
                <span class="status-text" id="statusText">è¿æ¥ä¸­...</span>
            </div>
        </header>

        <main class="main-content">
            <div class="text-display" id="textDisplay">
                <div class="welcome-message">
                    <p>ğŸ”Š ç­‰å¾…è¯­éŸ³è¯†åˆ«æ•°æ®...</p>
                    <p class="hint">è¯·ç¡®ä¿ASRç¨‹åºæ­£åœ¨è¿è¡Œ</p>
                </div>
            </div>
        </main>

        <footer class="footer">
            <div class="controls">
                <button class="btn btn-record" id="recordBtn">ğŸ¤ å¼€å§‹å½•éŸ³</button>
                <button class="btn btn-clear" id="clearBtn">æ¸…ç©ºæ–‡æœ¬</button>
                <button class="btn btn-save" id="saveBtn">ä¿å­˜æ–‡æœ¬</button>
                <button class="btn btn-summary" id="summaryBtn">ğŸ“ æ€»ç»“ä¼šè®®</button>
                <button class="btn btn-reconnect" id="reconnectBtn">é‡æ–°è¿æ¥</button>
            </div>
            <div class="info">
                <span>è¿æ¥çŠ¶æ€: <span id="connectionInfo">æœªè¿æ¥</span></span>
                <span>|</span>
                <span>æœ€åæ›´æ–°: <span id="lastUpdate">--</span></span>
            </div>
        </footer>

        <!-- ä¼šè®®æ€»ç»“å¼¹çª— -->
        <div class="modal" id="summaryModal" style="display: none;">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>ğŸ“ ä¼šè®®è®°å½•æ€»ç»“</h2>
                    <button class="modal-close" id="modalClose">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="summary-options">
                        <label>
                            <input type="radio" name="summaryType" value="brief" checked>
                            ç®€è¦æ€»ç»“ (é‡ç‚¹æ‘˜è¦)
                        </label>
                        <label>
                            <input type="radio" name="summaryType" value="detailed">
                            è¯¦ç»†æ€»ç»“ (å®Œæ•´åˆ†æ)
                        </label>
                        <label>
                            <input type="radio" name="summaryType" value="action">
                            è¡ŒåŠ¨é¡¹æ€»ç»“ (å¾…åŠäº‹é¡¹)
                        </label>
                    </div>
                    <div class="summary-result" id="summaryResult">
                        <div class="loading" id="summaryLoading" style="display: none;">
                            <div class="spinner"></div>
                            <p>æ­£åœ¨ç”Ÿæˆä¼šè®®æ€»ç»“ï¼Œè¯·ç¨å€™...</p>
                        </div>
                        <div class="summary-content" id="summaryContent" style="display: none;"></div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-primary" id="generateSummaryBtn">ç”Ÿæˆæ€»ç»“</button>
                    <button class="btn btn-secondary" id="saveSummaryBtn" style="display: none;">ä¿å­˜æ€»ç»“</button>
                    <button class="btn btn-secondary" id="copySummaryBtn" style="display: none;">å¤åˆ¶æ€»ç»“</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        class ASRWebSocketClient {
            constructor() {
                this.ws = null;
                this.reconnectAttempts = 0;
                this.maxReconnectAttempts = 5;
                this.reconnectDelay = 2000;
                this.isManualDisconnect = false;
                
                // éŸ³é¢‘å½•åˆ¶ç›¸å…³
                this.mediaRecorder = null;
                this.audioStream = null;
                this.isRecording = false;
                this.audioChunks = [];
                this.audioContext = null;
                this.processor = null;
                
                this.initElements();
                this.bindEvents();
                this.connect();
            }

            initElements() {
                this.statusDot = document.getElementById('statusDot');
                this.statusText = document.getElementById('statusText');
                this.textDisplay = document.getElementById('textDisplay');
                this.recordBtn = document.getElementById('recordBtn');
                this.clearBtn = document.getElementById('clearBtn');
                this.saveBtn = document.getElementById('saveBtn');
                this.summaryBtn = document.getElementById('summaryBtn');
                this.reconnectBtn = document.getElementById('reconnectBtn');
                this.connectionInfo = document.getElementById('connectionInfo');
                this.lastUpdate = document.getElementById('lastUpdate');

                // æ€»ç»“å¼¹çª—ç›¸å…³å…ƒç´ 
                this.summaryModal = document.getElementById('summaryModal');
                this.modalClose = document.getElementById('modalClose');
                this.generateSummaryBtn = document.getElementById('generateSummaryBtn');
                this.saveSummaryBtn = document.getElementById('saveSummaryBtn');
                this.copySummaryBtn = document.getElementById('copySummaryBtn');
                this.summaryLoading = document.getElementById('summaryLoading');
                this.summaryContent = document.getElementById('summaryContent');
                this.summaryResult = document.getElementById('summaryResult');
            }

            bindEvents() {
                this.recordBtn.addEventListener('click', () => this.toggleRecording());
                this.clearBtn.addEventListener('click', () => this.clearText());
                this.saveBtn.addEventListener('click', () => this.saveText());
                this.summaryBtn.addEventListener('click', () => this.showSummaryModal());
                this.reconnectBtn.addEventListener('click', () => this.reconnect());

                // æ€»ç»“å¼¹çª—äº‹ä»¶
                this.modalClose.addEventListener('click', () => this.hideSummaryModal());
                this.generateSummaryBtn.addEventListener('click', () => this.generateSummary());
                this.saveSummaryBtn.addEventListener('click', () => this.saveSummary());
                this.copySummaryBtn.addEventListener('click', () => this.copySummary());

                // ç‚¹å‡»å¼¹çª—å¤–éƒ¨å…³é—­
                this.summaryModal.addEventListener('click', (e) => {
                    if (e.target === this.summaryModal) {
                        this.hideSummaryModal();
                    }
                });

                // é”®ç›˜å¿«æ·é”®
                document.addEventListener('keydown', (e) => {
                    if (e.ctrlKey) {
                        switch(e.key) {
                            case 'l':
                                e.preventDefault();
                                this.clearText();
                                break;
                            case 's':
                                e.preventDefault();
                                this.saveText();
                                break;
                            case 'r':
                                e.preventDefault();
                                this.reconnect();
                                break;
                            case 'm':
                                e.preventDefault();
                                this.showSummaryModal();
                                break;
                        }
                    }
                    // ESCé”®å…³é—­å¼¹çª—
                    if (e.key === 'Escape') {
                        this.hideSummaryModal();
                    }
                });
            }

            connect() {
                try {
                    // åŠ¨æ€è·å– WebSocket è¿æ¥åœ°å€
                    const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                    const host = window.location.hostname === '0.0.0.0' ? 'localhost' : window.location.hostname;
                    const port = window.location.port;
                    const wsUrl = `${protocol}//${host}:${port}/ws/audio`;

                    console.log('è¿æ¥åˆ° WebSocket:', wsUrl);
                    this.ws = new WebSocket(wsUrl);

                    this.ws.onopen = () => {
                        console.log('WebSocketè¿æ¥å·²å»ºç«‹');
                        this.updateStatus('connected', 'å·²è¿æ¥');
                        this.reconnectAttempts = 0;
                        this.isManualDisconnect = false;
                        this.updateConnectionInfo('å·²è¿æ¥');
                    };

                    this.ws.onmessage = (event) => {
                        try {
                            const data = JSON.parse(event.data);
                            this.handleMessage(data);
                        } catch (e) {
                            console.error('è§£ææ¶ˆæ¯å¤±è´¥:', e);
                            // å°è¯•ç›´æ¥æ˜¾ç¤ºæ–‡æœ¬æ¶ˆæ¯
                            this.displayText(event.data, true);
                        }
                    };

                    this.ws.onclose = () => {
                        console.log('WebSocketè¿æ¥å·²å…³é—­');
                        this.updateStatus('disconnected', 'è¿æ¥æ–­å¼€');
                        this.updateConnectionInfo('è¿æ¥æ–­å¼€');
                        
                        if (!this.isManualDisconnect) {
                            this.attemptReconnect();
                        }
                    };

                    this.ws.onerror = (error) => {
                        console.error('WebSocketé”™è¯¯:', error);
                        this.updateStatus('error', 'è¿æ¥é”™è¯¯');
                        this.updateConnectionInfo('è¿æ¥é”™è¯¯');
                    };

                } catch (error) {
                    console.error('è¿æ¥å¤±è´¥:', error);
                    this.updateStatus('error', 'è¿æ¥å¤±è´¥');
                    this.updateConnectionInfo('è¿æ¥å¤±è´¥');
                    this.attemptReconnect();
                }
            }

            handleMessage(data) {
                switch (data.type) {
                    case 'welcome':
                        console.log('æ”¶åˆ°æ¬¢è¿æ¶ˆæ¯:', data.message);
                        if (data.session_info && data.session_info.current_text) {
                            this.displayText(data.session_info.current_text, true);
                        }
                        break;

                    case 'asr_result':
                    case 'recognition_result':
                        // å¤„ç† FastAPI æ ¼å¼çš„è¯†åˆ«ç»“æœ
                        if (data.result) {
                            this.displayText(data.result.text, data.result.is_final);
                        } else {
                            this.displayText(data.text, data.is_final);
                        }
                        this.updateLastUpdate();
                        break;

                    case 'pong':
                        // å¿ƒè·³å“åº”
                        break;

                    case 'error':
                        console.error('æœåŠ¡å™¨é”™è¯¯:', data.error_message);
                        this.updateStatus('error', 'æœåŠ¡å™¨é”™è¯¯');
                        break;

                    default:
                        console.log('æœªçŸ¥æ¶ˆæ¯ç±»å‹:', data);
                }
            }

            displayText(text, isFinal = true) {
                // æ¸…é™¤æ¬¢è¿æ¶ˆæ¯
                const welcomeMsg = this.textDisplay.querySelector('.welcome-message');
                if (welcomeMsg) {
                    welcomeMsg.remove();
                }

                if (isFinal) {
                    // æœ€ç»ˆç»“æœï¼šåˆ›å»ºæ–°çš„æ–‡æœ¬å…ƒç´ 
                    const textElement = document.createElement('div');
                    textElement.className = 'text-line final';
                    textElement.textContent = text;

                    // æ·»åŠ æ—¶é—´æˆ³
                    const timestamp = document.createElement('span');
                    timestamp.className = 'timestamp';
                    timestamp.textContent = new Date().toLocaleTimeString();
                    textElement.appendChild(timestamp);

                    this.textDisplay.appendChild(textElement);
                } else {
                    // é¢„è§ˆæ–‡æœ¬ï¼šæ›´æ–°æˆ–åˆ›å»ºé¢„è§ˆå…ƒç´ 
                    let previewElement = this.textDisplay.querySelector('.text-line.preview');
                    if (!previewElement) {
                        previewElement = document.createElement('div');
                        previewElement.className = 'text-line preview';
                        this.textDisplay.appendChild(previewElement);
                    }
                    previewElement.textContent = text;
                }

                // è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
                this.textDisplay.scrollTop = this.textDisplay.scrollHeight;
            }

            updateStatus(status, text) {
                this.statusDot.className = `status-dot ${status}`;
                this.statusText.textContent = text;
            }

            updateConnectionInfo(info) {
                this.connectionInfo.textContent = info;
            }

            updateLastUpdate() {
                const now = new Date();
                this.lastUpdate.textContent = now.toLocaleTimeString();
            }

            attemptReconnect() {
                if (this.reconnectAttempts < this.maxReconnectAttempts) {
                    this.reconnectAttempts++;
                    this.updateStatus('reconnecting', `é‡è¿ä¸­ (${this.reconnectAttempts}/${this.maxReconnectAttempts})`);
                    
                    setTimeout(() => {
                        console.log(`å°è¯•é‡è¿ ${this.reconnectAttempts}/${this.maxReconnectAttempts}`);
                        this.connect();
                    }, this.reconnectDelay);
                } else {
                    this.updateStatus('error', 'è¿æ¥å¤±è´¥');
                    this.updateConnectionInfo('è¿æ¥å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨é‡è¿');
                }
            }

            clearText() {
                this.textDisplay.innerHTML = '<div class="welcome-message"><p>æ–‡æœ¬å·²æ¸…ç©º</p></div>';
            }

            saveText() {
                const textElements = this.textDisplay.querySelectorAll('.text-line.final');
                if (textElements.length > 0) {
                    let allText = '';
                    textElements.forEach((element, index) => {
                        // æå–æ–‡æœ¬å†…å®¹ï¼ˆæ’é™¤æ—¶é—´æˆ³ï¼‰
                        const textContent = element.childNodes[0].textContent || element.textContent;
                        const timestamp = element.querySelector('.timestamp')?.textContent || '';
                        allText += `[${timestamp}] ${textContent}\n`;
                    });

                    const blob = new Blob([allText], { type: 'text/plain;charset=utf-8' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `è¯­éŸ³è½¬æ–‡å­—_${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.txt`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                } else {
                    alert('æ²¡æœ‰æ–‡æœ¬å¯ä¿å­˜');
                }
            }

            reconnect() {
                this.isManualDisconnect = true;
                if (this.ws) {
                    this.ws.close();
                }
                this.reconnectAttempts = 0;
                setTimeout(() => this.connect(), 500);
            }

            // éŸ³é¢‘å½•åˆ¶ç›¸å…³æ–¹æ³•
            async toggleRecording() {
                if (!this.isRecording) {
                    await this.startRecording();
                } else {
                    this.stopRecording();
                }
            }

            async startRecording() {
                try {
                    // è¯·æ±‚éº¦å…‹é£æƒé™
                    this.audioStream = await navigator.mediaDevices.getUserMedia({
                        audio: {
                            sampleRate: 16000,
                            channelCount: 1,
                            echoCancellation: true,
                            noiseSuppression: true
                        }
                    });

                    // åˆ›å»ºéŸ³é¢‘ä¸Šä¸‹æ–‡
                    this.audioContext = new (window.AudioContext || window.webkitAudioContext)({
                        sampleRate: 16000
                    });

                    const source = this.audioContext.createMediaStreamSource(this.audioStream);
                    
                    // åˆ›å»ºéŸ³é¢‘å¤„ç†å™¨ - ä½¿ç”¨æ›´å°çš„ç¼“å†²åŒºæé«˜å®æ—¶æ€§
                    this.processor = this.audioContext.createScriptProcessor(1024, 1, 1);
                    
                    this.processor.onaudioprocess = (event) => {
                        if (this.isRecording && this.ws && this.ws.readyState === WebSocket.OPEN) {
                            const inputBuffer = event.inputBuffer.getChannelData(0);
                            
                            // è½¬æ¢ä¸º16ä½PCM
                            const pcmData = this.float32ToPCM16(inputBuffer);
                            
                            // å‘é€éŸ³é¢‘æ•°æ®åˆ°æœåŠ¡å™¨ï¼ˆäºŒè¿›åˆ¶æ ¼å¼ï¼‰
                            this.ws.send(pcmData.buffer);
                        }
                    };

                    source.connect(this.processor);
                    this.processor.connect(this.audioContext.destination);

                    this.isRecording = true;
                    this.recordBtn.textContent = 'ğŸ›‘ åœæ­¢å½•éŸ³';
                    this.recordBtn.classList.add('recording');
                    
                    console.log('å¼€å§‹å½•éŸ³');
                    
                } catch (error) {
                    console.error('å¯åŠ¨å½•éŸ³å¤±è´¥:', error);
                    alert('æ— æ³•è®¿é—®éº¦å…‹é£ï¼Œè¯·æ£€æŸ¥æƒé™è®¾ç½®');
                }
            }

            stopRecording() {
                this.isRecording = false;
                
                if (this.processor) {
                    this.processor.disconnect();
                    this.processor = null;
                }
                
                if (this.audioContext) {
                    this.audioContext.close();
                    this.audioContext = null;
                }
                
                if (this.audioStream) {
                    this.audioStream.getTracks().forEach(track => track.stop());
                    this.audioStream = null;
                }
                
                this.recordBtn.textContent = 'ğŸ¤ å¼€å§‹å½•éŸ³';
                this.recordBtn.classList.remove('recording');
                
                console.log('åœæ­¢å½•éŸ³');
            }

            // å°†Float32Arrayè½¬æ¢ä¸º16ä½PCM
            float32ToPCM16(float32Array) {
                const pcm16 = new Int16Array(float32Array.length);
                for (let i = 0; i < float32Array.length; i++) {
                    const sample = Math.max(-1, Math.min(1, float32Array[i]));
                    pcm16[i] = sample < 0 ? sample * 0x8000 : sample * 0x7FFF;
                }
                return pcm16;
            }

            // å‘é€å¿ƒè·³
            sendHeartbeat() {
                if (this.ws && this.ws.readyState === WebSocket.OPEN) {
                    this.ws.send(JSON.stringify({ type: 'ping' }));
                }
            }

            // ä¼šè®®æ€»ç»“ç›¸å…³æ–¹æ³•
            showSummaryModal() {
                const textElements = this.textDisplay.querySelectorAll('.text-line.final');
                if (textElements.length === 0) {
                    alert('æ²¡æœ‰ä¼šè®®è®°å½•å¯ä»¥æ€»ç»“ï¼Œè¯·å…ˆè¿›è¡Œè¯­éŸ³è½¬æ–‡å­—');
                    return;
                }

                this.summaryModal.style.display = 'flex';
                this.resetSummaryModal();
            }

            hideSummaryModal() {
                this.summaryModal.style.display = 'none';
            }

            resetSummaryModal() {
                this.summaryLoading.style.display = 'none';
                this.summaryContent.style.display = 'none';
                this.saveSummaryBtn.style.display = 'none';
                this.copySummaryBtn.style.display = 'none';
                this.generateSummaryBtn.style.display = 'inline-block';
                this.summaryContent.innerHTML = '';
            }

            async generateSummary() {
                // è·å–æ‰€æœ‰ä¼šè®®æ–‡æœ¬
                const meetingText = this.getMeetingText();
                if (!meetingText.trim()) {
                    alert('æ²¡æœ‰ä¼šè®®å†…å®¹å¯ä»¥æ€»ç»“');
                    return;
                }

                // è·å–æ€»ç»“ç±»å‹
                const summaryType = document.querySelector('input[name="summaryType"]:checked').value;

                // æ˜¾ç¤ºåŠ è½½æç¤º
                const loadingText = this.summaryLoading.querySelector('p');
                const loadingMessages = {
                    'brief': 'æ­£åœ¨ç”Ÿæˆç®€è¦æ€»ç»“ï¼Œè¯·ç¨å€™...',
                    'detailed': 'æ­£åœ¨ç”Ÿæˆè¯¦ç»†æ€»ç»“ï¼Œè¯·ç¨å€™...',
                    'action': 'æ­£åœ¨æå–è¡ŒåŠ¨é¡¹ï¼Œè¯·ç¨å€™...'
                };
                loadingText.textContent = loadingMessages[summaryType] || 'æ­£åœ¨ç”Ÿæˆä¼šè®®æ€»ç»“ï¼Œè¯·ç¨å€™...';

                // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                this.summaryLoading.style.display = 'block';
                this.summaryContent.style.display = 'none';
                this.generateSummaryBtn.style.display = 'none';

                try {
                    // è°ƒç”¨æ–°çš„ä¼šè®®æ€»ç»“API
                    const summary = await this.callMeetingSummaryAPI(meetingText, summaryType);
                    this.displaySummary(summary, summaryType);
                } catch (error) {
                    console.error('ç”Ÿæˆæ€»ç»“å¤±è´¥:', error);
                    this.summaryLoading.style.display = 'none';
                    this.generateSummaryBtn.style.display = 'inline-block';
                    alert('ç”Ÿæˆæ€»ç»“å¤±è´¥: ' + error.message);
                }
            }

            getMeetingText() {
                const textElements = this.textDisplay.querySelectorAll('.text-line.final');
                let meetingText = '';

                textElements.forEach((element, index) => {
                    const textContent = element.childNodes[0].textContent || element.textContent;
                    const timestamp = element.querySelector('.timestamp')?.textContent || '';
                    meetingText += `[${timestamp}] ${textContent}\n`;
                });

                return meetingText;
            }

            async callMeetingSummaryAPI(meetingText, summaryType) {
                /**
                 * è°ƒç”¨æ–°çš„ä¼šè®®æ€»ç»“API
                 * è¯¥APIä¼šè‡ªåŠ¨è¿›è¡Œä¸¤æ­¥å¤„ç†ï¼š1. ä¼˜åŒ–ASRæ–‡æœ¬ 2. ç”Ÿæˆå¯¹åº”æ€»ç»“
                 */
                const requestData = {
                    meeting_text: meetingText,
                    summary_type: summaryType,
                    model: 'gemini-1.5-flash',
                    temperature: 0.3
                };

                const response = await fetch('/api/meeting/summary', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestData)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || 'è¯·æ±‚å¤±è´¥');
                }

                const data = await response.json();

                // å¦‚æœå¼€å¯è°ƒè¯•æ¨¡å¼ï¼Œå¯ä»¥åœ¨æ§åˆ¶å°æŸ¥çœ‹ä¼˜åŒ–åçš„æ–‡æœ¬
                if (data.optimized_text) {
                    console.log('ä¼˜åŒ–åçš„æ–‡æœ¬:', data.optimized_text);
                }

                return data.summary;
            }

            async callLLMSummary(meetingText, summaryType) {
                /**
                 * åŸæœ‰çš„LLMè°ƒç”¨æ–¹æ³•ï¼ˆä¿ç•™ä½œä¸ºå¤‡ç”¨ï¼‰
                 * æ³¨æ„ï¼šè¿™ä¸ªæ–¹æ³•ç°åœ¨åªç”¨äºå‘åå…¼å®¹ï¼Œæ¨èä½¿ç”¨callMeetingSummaryAPI
                 */
                const prompts = {
                    brief: `ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„ä¼šè®®è®°å½•åˆ†æä¸“å®¶ã€‚ä»¥ä¸‹æ˜¯ä¼šè®®è®°å½•æ–‡æœ¬ï¼Œè¯·æå–å…³é”®è¦ç‚¹å¹¶è¿›è¡Œç®€è¦æ€»ç»“ã€‚

**ä¼šè®®è®°å½•ï¼š**
${meetingText}

**åˆ†æè¦æ±‚ï¼š**
1. **å…³é”®ä¿¡æ¯æå–**: é‡ç‚¹å…³æ³¨å†³ç­–ã€è¡ŒåŠ¨é¡¹ã€é‡è¦è®¨è®ºç‚¹
2. **é€»è¾‘æ¢³ç†**: æ•´ç†ä¼šè®®çš„ä¸»è¦è„‰ç»œå’Œæ ¸å¿ƒå†…å®¹
3. **å‡†ç¡®è¡¨è¾¾**: ç”¨å‡†ç¡®ã€ä¸“ä¸šçš„è¯­è¨€è¡¨è¾¾æ€»ç»“å†…å®¹

**è¾“å‡ºæ ¼å¼ï¼š**
## ğŸ“‹ ä¼šè®®ç®€è¦æ€»ç»“

### ğŸ¯ ä¸»è¦è®®é¢˜
- [åˆ—å‡ºä¸»è¦è®¨è®ºçš„è®®é¢˜]

### âœ… å…³é”®å†³å®š
- [åˆ—å‡ºé‡è¦å†³å®šå’Œç»“è®º]

### ğŸ’¡ é‡è¦ä¿¡æ¯
- [åˆ—å‡ºå…¶ä»–é‡è¦ä¿¡æ¯]

`,

                    detailed: `ä½ æ˜¯ä¸€ä¸ªèµ„æ·±çš„ä¼šè®®åˆ†æå¸ˆï¼Œæ“…é•¿æå–å’Œæ•´ç†å®Œæ•´çš„ä¼šè®®ä¿¡æ¯ã€‚ä»¥ä¸‹æ˜¯ä¼šè®®è®°å½•æ–‡æœ¬ï¼Œè¯·è¿›è¡Œè¯¦ç»†åˆ†æå’Œæ€»ç»“ã€‚

**ä¼šè®®è®°å½•ï¼š**
${meetingText}

**åˆ†æè¦æ±‚ï¼š**
1. **å…¨é¢åˆ†æ**: æ·±å…¥åˆ†æä¼šè®®çš„å„ä¸ªæ–¹é¢å’Œå±‚æ¬¡
2. **é€»è¾‘æ¢³ç†**: ç»„ç»‡å’Œæ¢³ç†ä¼šè®®å†…å®¹çš„é€»è¾‘ç»“æ„
3. **ä¸“ä¸šè¡¨è¾¾**: ä½¿ç”¨å‡†ç¡®ã€ä¸“ä¸šçš„å•†åŠ¡è¯­è¨€è¿›è¡Œè¡¨è¿°
4. **ç»†èŠ‚ä¿ç•™**: ä¿ç•™é‡è¦çš„è®¨è®ºç»†èŠ‚å’Œå…³é”®ä¿¡æ¯

**è¾“å‡ºæ ¼å¼ï¼š**
## ğŸ“Š ä¼šè®®è¯¦ç»†æ€»ç»“

### ğŸ¯ ä¼šè®®æ¦‚è¿°
[æè¿°ä¼šè®®çš„æ•´ä½“æƒ…å†µã€èƒŒæ™¯å’Œç›®æ ‡]

### ğŸ’¬ è®¨è®ºå†…å®¹
[è¯¦ç»†æè¿°å„ä¸ªè®®é¢˜çš„è®¨è®ºè¿‡ç¨‹ï¼Œä¿æŒé€»è¾‘æ¸…æ™°]

### ğŸ“‹ å†³ç­–äº‹é¡¹
[åˆ—å‡ºæ‰€æœ‰å†³å®šå’Œå†³ç­–]

### ğŸ” å…³é”®è§‚ç‚¹
[è®°å½•é‡è¦çš„è§‚ç‚¹å’Œå»ºè®®]

### ğŸ“… åç»­å®‰æ’
[æ•´ç†åç»­è®¡åˆ’æˆ–å®‰æ’]

`,

                    action: `ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„é¡¹ç›®ç®¡ç†ä¸“å®¶ï¼Œæ“…é•¿ä»ä¼šè®®è®°å½•ä¸­æå–å¯æ‰§è¡Œçš„è¡ŒåŠ¨é¡¹ã€‚ä»¥ä¸‹æ˜¯ä¼šè®®è®°å½•æ–‡æœ¬ï¼Œè¯·æå–å‡†ç¡®çš„è¡ŒåŠ¨é¡¹å’Œå¾…åŠäº‹é¡¹ã€‚

**ä¼šè®®è®°å½•ï¼š**
${meetingText}

**æå–è¦æ±‚ï¼š**
1. **å‡†ç¡®è¯†åˆ«**: å‡†ç¡®è¯†åˆ«ä¼šè®®ä¸­çš„è¡ŒåŠ¨é¡¹
2. **è´£ä»»æ˜ç¡®**: è¯†åˆ«å’Œæ˜ç¡®ä»»åŠ¡çš„è´Ÿè´£äºº
3. **æ—¶é—´æ˜ç¡®**: å‡†ç¡®æå–æ—¶é—´èŠ‚ç‚¹å’Œæˆªæ­¢æ—¥æœŸ
4. **ä»»åŠ¡å…·ä½“**: å°†æ¨¡ç³Šçš„è¡¨è¿°è½¬åŒ–ä¸ºå…·ä½“å¯æ‰§è¡Œçš„ä»»åŠ¡
5. **ä¼˜å…ˆçº§åˆ¤æ–­**: æ ¹æ®è®¨è®ºå†…å®¹åˆ¤æ–­ä»»åŠ¡çš„é‡è¦æ€§å’Œç´§æ€¥æ€§

**è¾“å‡ºæ ¼å¼ï¼š**
## ğŸ“‹ è¡ŒåŠ¨é¡¹æ€»ç»“

### âœ… å¾…åŠäº‹é¡¹
- **ä»»åŠ¡**: [å…·ä½“çš„å¾…åŠä»»åŠ¡]
- **è´Ÿè´£äºº**: [è´Ÿè´£äººå§“åæˆ–éƒ¨é—¨ï¼Œå¦‚æœ‰æåŠ]
- **æˆªæ­¢æ—¶é—´**: [æ—¶é—´èŠ‚ç‚¹]
- **ä¼˜å…ˆçº§**: [é«˜/ä¸­/ä½ï¼ŒåŸºäºè®¨è®ºå†…å®¹åˆ¤æ–­]

### ğŸ”„ è·Ÿè¿›äº‹é¡¹
- [éœ€è¦æŒç»­è·Ÿè¿›çš„äº‹é¡¹]

### ğŸ“… ä¸‹æ¬¡ä¼šè®®è®®é¢˜
- [ä¸‹æ¬¡ä¼šè®®éœ€è¦è®¨è®ºçš„å†…å®¹]

### âš ï¸ æ³¨æ„äº‹é¡¹
- [éœ€è¦ç‰¹åˆ«æ³¨æ„çš„äº‹é¡¹å’Œé£é™©ç‚¹]

`,

                    optimize: `ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„è¯­éŸ³è¯†åˆ«æ–‡æœ¬ä¼˜åŒ–ä¸“å®¶ã€‚ä»¥ä¸‹æ˜¯é€šè¿‡ASR(è¯­éŸ³è¯†åˆ«)æŠ€æœ¯è½¬æ¢çš„ä¼šè®®è®°å½•æ–‡æœ¬ï¼Œç”±äºè¯­éŸ³è¯†åˆ«æŠ€æœ¯çš„å±€é™æ€§ï¼Œæ–‡æœ¬ä¸­å­˜åœ¨å„ç§è¯†åˆ«é”™è¯¯ã€‚è¯·å¸®åŠ©æˆ‘ä¼˜åŒ–å’Œä¿®æ­£è¿™äº›æ–‡æœ¬ï¼Œç¡®ä¿ä¼˜åŒ–åçš„æ–‡æœ¬è¯­ä¹‰å‡†ç¡®ã€è¯­è¨€æµç•…ã€é€»è¾‘æ¸…æ™°ï¼ŒåŒæ—¶å®Œå…¨ä¿æŒä¼šè®®è®°å½•çš„åŸå§‹å«ä¹‰å’Œé‡è¦ä¿¡æ¯ã€‚

**åŸå§‹ASRè¯†åˆ«æ–‡æœ¬ï¼š**
${meetingText}

**è¯¦ç»†ä¼˜åŒ–è¦æ±‚ï¼š**

1. **åŒéŸ³å­—é”™è¯¯ä¿®æ­£**ï¼š
   - ä¿®æ­£å¸¸è§åŒéŸ³å­—é”™è¯¯ï¼šåœ¨/å†ã€çš„/å¾—ã€åš/ä½œã€é‚£/å“ªã€å› ä¸º/åº”ä¸ºã€ä»¥å/å·²åã€ç°åœ¨/ç°å†ç­‰
   - æ ¹æ®ä¸Šä¸‹æ–‡è¯­å¢ƒé€‰æ‹©æ­£ç¡®ç”¨å­—
   - ç‰¹åˆ«æ³¨æ„åŠ¨è¯ã€ä»‹è¯ã€åŠ©è¯çš„æ­£ç¡®ä½¿ç”¨

2. **æ ‡ç‚¹ç¬¦å·ä¼˜åŒ–**ï¼š
   - è¡¥å……ç¼ºå¤±çš„é€—å·ã€å¥å·ã€é—®å·ã€æ„Ÿå¹å·ã€å†’å·ã€åˆ†å·
   - ä¼˜åŒ–è¯­å¥æ–­å¥ï¼Œæå‡æ–‡æœ¬å¯è¯»æ€§
   - ä¸ºç›´æ¥å¼•è¯­æ·»åŠ å¼•å·
   - åˆç†ä½¿ç”¨é¡¿å·åˆ†éš”å¹¶åˆ—æˆåˆ†

3. **è¯­æ³•å’Œè¡¨è¾¾ä¼˜åŒ–**ï¼š
   - ä¿®æ­£è¯­åºé”™è¯¯å’Œä¸é€šé¡ºçš„è¡¨è¾¾
   - è¡¥å……ç¼ºå¤±çš„ä¸»è¯­ã€è°“è¯­ã€å®¾è¯­
   - ä¿®æ­£æ—¶æ€å’Œè¯­æ€é”™è¯¯
   - ä¼˜åŒ–å£è¯­åŒ–è¡¨è¾¾ï¼Œä½¿å…¶æ›´åŠ ä¹¦é¢åŒ–å’Œä¸“ä¸š

4. **æ ¼å¼å’Œç»“æ„ä¿æŒ**ï¼š
   - ä¸¥æ ¼ä¿æŒåŸå§‹æ—¶é—´æˆ³æ ¼å¼ï¼š[HH:MM:SS]
   - ä¿æŒä¼šè®®è®°å½•çš„æ—¶é—´é¡ºåº
   - ç»´æŒå‘è¨€äººä¿¡æ¯ï¼ˆå¦‚æœ‰ï¼‰
   - ä¿æŒæ®µè½ç»“æ„çš„é€»è¾‘æ€§

5. **å†…å®¹å‡†ç¡®æ€§**ï¼š
   - ä¿æŒåŸæ„ä¸å˜ï¼Œåªè¿›è¡Œå¿…è¦çš„ä¿®æ­£
   - å¯¹ä¸“ä¸šæœ¯è¯­å’Œäººåæ ¹æ®ä¸Šä¸‹æ–‡è¿›è¡Œåˆç†æ¨æ–­
   - ä¸æ·»åŠ åŸæ–‡ä¸­æ²¡æœ‰çš„ä¿¡æ¯
   - ä¿æŒä¼šè®®å†…å®¹çš„çœŸå®æ€§å’Œå®Œæ•´æ€§

**è¾“å‡ºæ ¼å¼è¦æ±‚ï¼š**

[åœ¨æ­¤è¾“å‡ºå®Œæ•´çš„ä¼˜åŒ–åä¼šè®®è®°å½•ï¼Œä¸¥æ ¼ä¿æŒæ—¶é—´æˆ³æ ¼å¼]

`
                };

                // æ ¹æ®åŠŸèƒ½ç±»å‹è®¾ç½®åˆé€‚çš„Tokené™åˆ¶
                const tokenLimits = {
                    'brief': 1200,      // ç®€è¦æ€»ç»“éœ€è¦é€‚ä¸­çš„ç©ºé—´
                    'detailed': 1800,   // è¯¦ç»†æ€»ç»“éœ€è¦æ›´å¤šç©ºé—´
                    'action': 1500,     // è¡ŒåŠ¨é¡¹éœ€è¦è¾ƒå¤šç©ºé—´åˆ—ä¸¾ä»»åŠ¡
                    'optimize': 2000    // ä¼˜åŒ–åŠŸèƒ½éœ€è¦æœ€å¤šç©ºé—´è¾“å‡ºå®Œæ•´æ–‡æœ¬
                };

                const requestData = {
                    model: 'gemini-1.5-flash',
                    messages: [
                        { role: 'user', content: prompts[summaryType] }
                    ],
                    temperature: 0.3,
                    max_tokens: tokenLimits[summaryType] || 1000
                };

                const response = await fetch('/llm/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestData)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || 'è¯·æ±‚å¤±è´¥');
                }

                const data = await response.json();
                return data.content;
            }

            displaySummary(summary, summaryType) {
                this.summaryLoading.style.display = 'none';
                this.summaryContent.style.display = 'block';
                this.saveSummaryBtn.style.display = 'inline-block';
                this.copySummaryBtn.style.display = 'inline-block';

                // æ ¹æ®ç±»å‹æ›´æ–°ä¿å­˜æŒ‰é’®æ–‡æœ¬
                const buttonTexts = {
                    'brief': 'ä¿å­˜ç®€è¦æ€»ç»“',
                    'detailed': 'ä¿å­˜è¯¦ç»†æ€»ç»“',
                    'action': 'ä¿å­˜è¡ŒåŠ¨é¡¹'
                };
                this.saveSummaryBtn.textContent = buttonTexts[summaryType] || 'ä¿å­˜æ€»ç»“';

                // å°†Markdownæ ¼å¼è½¬æ¢ä¸ºHTMLæ˜¾ç¤º
                this.summaryContent.innerHTML = this.markdownToHtml(summary);
            }

            markdownToHtml(markdown) {
                let html = markdown
                    .replace(/^## (.*$)/gm, '<h2>$1</h2>')
                    .replace(/^### (.*$)/gm, '<h3>$1</h3>')
                    .replace(/^- (.*$)/gm, '<li>$1</li>')
                    .replace(/(<li>.*<\/li>)/gs, '<ul>$1</ul>')
                    .replace(/\n\n/g, '<br><br>')
                    .replace(/\n/g, '<br>');

                // ä¸ºæ—¶é—´æˆ³æ·»åŠ ç‰¹æ®Šæ ·å¼ï¼ˆæ ¼å¼ï¼š[HH:MM:SS]ï¼‰
                html = html.replace(/\[(\d{2}:\d{2}:\d{2})\]/g, '<span class="timestamp">[$1]</span>');

                return html;
            }

            saveSummary() {
                const summaryText = this.summaryContent.textContent || this.summaryContent.innerText;
                const meetingDate = new Date().toISOString().slice(0, 19).replace(/:/g, '-');
                const summaryType = document.querySelector('input[name="summaryType"]:checked').value;

                // æ ¹æ®ç±»å‹è®¾ç½®ä¸åŒçš„æ–‡ä»¶å
                let fileName;
                switch(summaryType) {
                    case 'brief':
                        fileName = `ä¼šè®®ç®€è¦æ€»ç»“_${meetingDate}.txt`;
                        break;
                    case 'detailed':
                        fileName = `ä¼šè®®è¯¦ç»†æ€»ç»“_${meetingDate}.txt`;
                        break;
                    case 'action':
                        fileName = `ä¼šè®®è¡ŒåŠ¨é¡¹_${meetingDate}.txt`;
                        break;
                    default:
                        fileName = `ä¼šè®®æ€»ç»“_${meetingDate}.txt`;
                }

                const blob = new Blob([summaryText], { type: 'text/plain;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = fileName;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }

            async copySummary() {
                const summaryText = this.summaryContent.textContent || this.summaryContent.innerText;

                try {
                    await navigator.clipboard.writeText(summaryText);
                    // ä¸´æ—¶æ”¹å˜æŒ‰é’®æ–‡æœ¬ä»¥æ˜¾ç¤ºæˆåŠŸ
                    const originalText = this.copySummaryBtn.textContent;
                    this.copySummaryBtn.textContent = 'âœ… å·²å¤åˆ¶';
                    setTimeout(() => {
                        this.copySummaryBtn.textContent = originalText;
                    }, 2000);
                } catch (error) {
                    console.error('å¤åˆ¶å¤±è´¥:', error);
                    alert('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨é€‰æ‹©æ–‡æœ¬å¤åˆ¶');
                }
            }
        }

        // åˆå§‹åŒ–å®¢æˆ·ç«¯
        const client = new ASRWebSocketClient();

        // å®šæœŸå‘é€å¿ƒè·³
        setInterval(() => client.sendHeartbeat(), 30000);
    </script>
</body>
</html>
