# 项目结构重构说明

## 🎯 重构目标

将项目重构为符合Poetry包管理的标准结构，所有导入都从`src`开始，不再使用`sys.path.append`手动添加路径，并且使用`./venv/python.exe`解释器而不是直接使用`python`命令。

## 📁 新的项目结构

```
FunASR-Online-Paraformer-Test/
├── src/                               # 源代码目录
│   ├── __init__.py                   # 包初始化文件
│   ├── asr/                          # ASR语音识别模块
│   │   ├── __init__.py
│   │   └── streaming_paraformer.py   # ASR主程序
│   ├── asr_config.py                 # ASR配置文件
│   ├── config_switcher.py            # 配置切换工具
│   ├── system_launcher.py            # 系统启动器
│   └── websocket_server.py           # WebSocket服务器
├── test/                             # 测试目录
│   ├── __init__.py                   # 测试包初始化
│   ├── test_frontend.py              # 前端测试
│   ├── test_integrated_system.py     # 集成测试
│   └── test_asr_optimization.py      # 优化效果测试
├── frontend/                         # 前端文件
│   ├── index.html                    # 前端页面
│   └── style.css                     # 样式文件
├── docs/                             # 文档目录
│   ├── FunASR_优化配置说明.md        # 优化配置说明
│   └── 使用指南.md                   # 使用指南
├── run_system.py                     # 主启动脚本
├── switch_config.py                  # 配置切换脚本
├── run_tests.py                      # 测试运行脚本
├── pyproject.toml                    # Poetry配置
├── requirements.txt                  # pip依赖文件
└── README.md                         # 项目说明
```

## 🔄 主要变更

### 1. 文件移动

| 原位置 | 新位置 | 说明 |
|--------|--------|------|
| `asr_config.py` | `src/asr_config.py` | 配置文件移到src目录 |
| `switch_asr_config.py` | `src/config_switcher.py` | 重命名并移动 |
| `start_asr_system.py` | `src/system_launcher.py` | 重命名并移动 |
| `test_*.py` | `test/test_*.py` | 所有测试文件移到test目录 |

### 2. 导入语句修改

**旧的导入方式（使用sys.path.append）：**
```python
import sys
import os
sys.path.append(os.path.join(os.path.dirname(__file__), '..', '..'))
from asr_config import get_config
```

**新的导入方式（使用Poetry包结构）：**
```python
from src.asr_config import get_config
```

### 3. 新的启动脚本

#### 主启动脚本：`run_system.py`
```bash
python run_system.py
```
- 使用`./venv/python.exe`解释器运行系统
- 自动检查虚拟环境解释器
- 在新窗口启动WebSocket服务器

#### 配置切换脚本：`switch_config.py`
```bash
python switch_config.py meeting
```
- 简化的配置切换接口
- 支持命令行参数

#### 测试运行脚本：`run_tests.py`
```bash
python run_tests.py frontend
```
- 统一的测试运行接口
- 支持不同类型的测试

## 🚀 使用方法

### 1. 安装依赖

```bash
# 使用Poetry（推荐）
poetry install

# 或使用pip
pip install -r requirements.txt
```

### 2. 启动系统

```bash
# 一键启动（使用虚拟环境解释器）
python run_system.py

# 或分步启动（推荐使用虚拟环境解释器）
./venv/python.exe -m src.websocket_server
./venv/python.exe -m src.asr.streaming_paraformer

# 或使用Poetry
poetry run python -m src.websocket_server
poetry run python -m src.asr.streaming_paraformer
```

### 3. 切换配置

```bash
# 交互式切换
python switch_config.py

# 命令行切换
python switch_config.py meeting
```

### 4. 运行测试

```bash
# 前端测试
python run_tests.py frontend

# 集成测试
python run_tests.py integration

# 优化测试
python run_tests.py optimization
```

## 📦 Poetry配置

`pyproject.toml`文件配置了包结构：

```toml
[tool.poetry]
name = "asr_service"
version = "0.1.0"
packages = [{include = "src", from="."}]

[tool.poetry.dependencies]
python = "^3.9"
websockets = "^12.0"
numpy = "^1.24.0"
sounddevice = "^0.4.6"
rich = "^13.0.0"
colorama = "^0.4.6"
soundfile = "^0.12.1"
```

## 🔧 开发说明

### 模块导入规则

1. **内部模块导入**：始终使用`from src.module import ...`
2. **测试模块导入**：使用`from test.module import ...`
3. **不再使用**：`sys.path.append`手动添加路径

### 运行模块

#### 使用虚拟环境解释器（推荐）
```bash
# 运行WebSocket服务器
./venv/python.exe -m src.websocket_server

# 运行ASR服务
./venv/python.exe -m src.asr.streaming_paraformer

# 运行配置切换工具
./venv/python.exe -m src.config_switcher

# 运行测试
./venv/python.exe -m test.test_frontend
```

#### 使用Poetry
```bash
# 运行WebSocket服务器
poetry run python -m src.websocket_server

# 运行ASR服务
poetry run python -m src.asr.streaming_paraformer

# 运行配置切换工具
poetry run python -m src.config_switcher

# 运行测试
poetry run python -m test.test_frontend
```

## ✅ 重构优势

1. **标准化结构**：符合Python包管理最佳实践
2. **清晰的模块分离**：源代码、测试、文档分离
3. **简化的导入**：不再需要手动路径管理
4. **Poetry集成**：更好的依赖管理和虚拟环境
5. **易于维护**：清晰的项目结构便于维护和扩展

## 🔄 迁移指南

如果您有自定义的脚本或配置，请按以下方式更新：

1. **更新导入语句**：将所有`from module`改为`from src.module`
2. **更新运行命令**：使用`poetry run python -m src.module`
3. **更新测试**：将测试文件移到`test/`目录
4. **更新文档**：参考新的项目结构

## 🆘 故障排除

### 导入错误
如果遇到导入错误，请确保：
1. 已安装Poetry：`poetry --version`
2. 已安装依赖：`poetry install`
3. 使用正确的运行命令：`poetry run python -m src.module`

### 模块未找到
如果提示模块未找到：
1. 检查`pyproject.toml`中的packages配置
2. 确保所有目录都有`__init__.py`文件
3. 使用`poetry run`前缀运行命令
